<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon Manager - Run v4</title>
    <style>
        /* --- デザイン設定 --- */
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --border-color: #e5e7eb;
            --red: #ef4444;
            --green: #22c55e;
            --blue: #3b82f6;
            --gray: #9ca3af;
            --purple: #8b5cf6;
            --orange: #f97316;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: #111827;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        header {
            height: 40px; background-color: #1f2937; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; font-size: 14px; font-weight: bold; flex-shrink: 0;
        }

        .screen {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            width: 100%; height: 100%;
        }
        .hidden { display: none !important; }

        /* --- 測定画面 --- */
        #athletes-container {
            flex: 1; display: flex; overflow-x: auto; overflow-y: hidden;
            background-color: var(--bg-color); padding-bottom: 80px; 
        }

        .stopwatch-card {
            flex: 0 0 320px; background-color: var(--card-bg);
            border-right: 1px solid var(--border-color); display: flex;
            flex-direction: column; padding: 12px; position: relative;
            box-sizing: border-box; height: 100%;
        }

        .delete-btn {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: var(--border-color); cursor: pointer; font-size: 18px;
        }
        .delete-btn:hover { color: var(--red); }

        .name-input {
            font-size: 20px; font-weight: bold; text-align: center; border: none;
            border-bottom: 2px solid var(--border-color); width: 80%;
            margin: 0 auto 10px auto; padding: 4px; outline: none;
        }
        .name-input:focus { border-color: var(--blue); }

        .time-display-area {
            background-color: #f9fafb; border-radius: 8px; padding: 10px;
            text-align: center; margin-bottom: 12px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }

        .main-time-label { font-size: 10px; color: var(--gray); font-weight: bold; }
        .main-time {
            font-family: monospace; font-size: 36px; font-weight: bold;
            color: var(--text-main); letter-spacing: 1px; margin: 4px 0 12px 0;
        }

        .sub-times { display: flex; gap: 8px; }
        .sub-time-box {
            flex: 1; background: white; border: 1px solid var(--border-color);
            border-radius: 4px; padding: 4px;
        }
        .sub-label { font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .sub-time { font-family: monospace; font-size: 18px; font-weight: bold; }

        .text-blue { color: #1e40af; } .text-green { color: #166534; }

        .controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .row-btns { display: flex; gap: 8px; height: 40px; }
        
        button {
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            font-size: 14px; transition: opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #d1d5db; cursor: not-allowed; }

        .btn-start { background-color: var(--green); color: white; flex: 1; }
        .btn-stop { background-color: var(--red); color: white; flex: 1; }
        .btn-lap { background-color: var(--blue); color: white; flex: 1; }
        .btn-reset { background-color: #e5e7eb; color: #4b5563; width: 100%; padding: 8px; }

        .lap-list-container {
            flex: 1; overflow-y: auto; background-color: #f9fafb;
            border: 1px solid var(--border-color); border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; }
        th { background-color: #f3f4f6; padding: 6px; font-size: 11px; color: var(--gray); position: sticky; top: 0; }
        td { padding: 4px; border-bottom: 1px solid #e5e7eb; color: var(--text-main); }
        .mono { font-family: monospace; }
        .lap-split { font-weight: bold; color: #1e40af; }

        #add-btn-area {
            flex: 0 0 100px; display: flex; align-items: center; justify-content: center;
            background-color: #e5e7eb; border-left: 1px solid #d1d5db;
        }
        .add-circle {
            width: 60px; height: 60px; border-radius: 50%; background-color: white;
            color: var(--blue); display: flex; align-items: center; justify-content: center;
            font-size: 32px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer;
        }

        /* --- 一括操作バー --- */
        #global-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background-color: #1f2937; display: flex; align-items: center;
            justify-content: space-around; padding: 0 10px; box-sizing: border-box;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.2); z-index: 100;
        }
        
        .global-btn {
            height: 50px; flex: 1; margin: 0 5px; font-size: 16px; color: white;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .global-btn span { font-size: 10px; font-weight: normal; margin-top: 2px; opacity: 0.8; }

        .g-start { background-color: #16a34a; }
        .g-lap { background-color: #2563eb; }
        .g-stop { background-color: #dc2626; }
        .g-finish { background-color: var(--orange); }

        /* --- 編集画面 (スプレッドシート風) --- */
        #edit-screen {
            background-color: var(--bg-color); padding: 10px; box-sizing: border-box;
        }

        .edit-container {
            width: 100%; height: 100%; background: white; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;
            overflow: hidden;
        }

        .sheet-header {
            padding: 10px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-header h2 { margin: 0; font-size: 16px; }

        /* スプレッドシート本体 */
        .spreadsheet-wrapper {
            flex: 1; overflow: auto; padding: 10px;
        }

        .spreadsheet-table {
            border-collapse: collapse; width: max-content; /* 中身に合わせて広がる */
        }
        .spreadsheet-table th, .spreadsheet-table td {
            border: 1px solid #ccc; padding: 0; min-width: 80px;
        }
        .spreadsheet-table th {
            background-color: #f3f4f6; padding: 8px; font-size: 12px;
            text-align: center; position: sticky; top: 0; z-index: 10;
        }
        .spreadsheet-table input {
            width: 100%; height: 100%; border: none; padding: 8px;
            box-sizing: border-box; font-family: monospace; font-size: 14px;
            text-align: center;
        }
        .spreadsheet-table input:focus {
            background-color: #eff6ff; outline: 2px solid var(--blue); z-index: 5;
        }
        
        /* 選手名ヘッダーの強調 */
        .th-name { background-color: #e5e7eb; font-weight: bold; font-size: 14px; }

        .edit-actions {
            display: flex; gap: 10px; padding: 10px; border-top: 1px solid #ddd;
        }

        .btn-copy { background-color: #107c41; /* Excel Green */ color: white; flex: 2; font-size: 16px; }
        .btn-back { background-color: #6b7280; color: white; flex: 1; font-size: 16px; }

    </style>
</head>
<body>

<header>
    <span>Triathlon Manager - Run</span>
</header>

<div id="measurement-screen" class="screen">
    <div id="athletes-container">
        <div id="add-btn-area">
            <div class="add-circle" onclick="addAthlete()">+</div>
        </div>
    </div>

    <div id="global-controls">
        <button class="global-btn g-start" onclick="startAll()">START<span>一括開始</span></button>
        <button class="global-btn g-lap" onclick="lapAll()">LAP<span>一括ラップ</span></button>
        <button class="global-btn g-stop" onclick="stopAll()">STOP<span>一括停止</span></button>
        <button class="global-btn g-finish" onclick="finishMeasurement()">FINISH<span>測定終了</span></button>
    </div>
</div>

<div id="edit-screen" class="screen hidden">
    <div class="edit-container">
        <div class="sheet-header">
            <h2 id="result-title">計測結果</h2>
        </div>
        
        <div class="spreadsheet-wrapper">
            <table class="spreadsheet-table" id="result-table">
                </table>
        </div>

        <div class="edit-actions">
            <button class="btn-back" onclick="backToMeasurement()">戻る</button>
            <button class="btn-copy" onclick="copySpreadsheet()">Excel形式でコピー</button>
        </div>
    </div>
</div>

<script>
    let athletes = [];
    let nextId = 1;

    function formatTime(ms) {
        if (ms === 0) return "00:00.00";
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        const milliseconds = Math.floor((ms % 1000) / 10);
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
    }

    class Stopwatch {
        constructor(id) {
            this.id = id;
            this.startTime = 0; this.elapsedSaved = 0; this.isRunning = false;
            this.animationFrame = null; this.laps = []; this.currentLapStart = 0; 

            this.element = document.createElement('div');
            this.element.className = 'stopwatch-card';
            this.element.id = `athlete-${id}`;
            this.render();
            
            this.nameInput = this.element.querySelector('.name-input');
            this.totalTimeDisplay = this.element.querySelector('.main-time');
            this.currentLapDisplay = this.element.querySelector('.current-lap');
            this.lastLapDisplay = this.element.querySelector('.last-lap');
            this.startStopBtn = this.element.querySelector('.btn-toggle');
            this.lapBtn = this.element.querySelector('.btn-lap');
            this.tbody = this.element.querySelector('tbody');
        }

        render() {
            this.element.innerHTML = `
                <button class="delete-btn" onclick="removeAthlete(${this.id})">×</button>
                <input type="text" class="name-input" placeholder="氏名" value="選手 ${this.id}">
                
                <div class="time-display-area">
                    <div class="main-time-label">TOTAL TIME</div>
                    <div class="main-time">00:00.00</div>
                    <div class="sub-times">
                        <div class="sub-time-box">
                            <div class="sub-label text-blue">Current Lap</div>
                            <div class="sub-time current-lap text-blue">00:00.00</div>
                        </div>
                        <div class="sub-time-box">
                            <div class="sub-label text-green">Last Lap</div>
                            <div class="sub-time last-lap text-green">00:00.00</div>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="row-btns">
                        <button class="btn-toggle btn-start" onclick="toggleTimer(${this.id})">START</button>
                        <button class="btn-lap" onclick="recordLap(${this.id})" disabled>LAP</button>
                    </div>
                    <button class="btn-reset" onclick="resetTimer(${this.id})">RESET</button>
                </div>

                <div class="lap-list-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>SPLIT</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;
        }

        update() {
            const now = Date.now();
            const totalTime = this.elapsedSaved + (this.isRunning ? (now - this.startTime) : 0);
            this.totalTimeDisplay.textContent = formatTime(totalTime);
            const currentLapTime = totalTime - this.currentLapStart;
            this.currentLapDisplay.textContent = formatTime(currentLapTime);
            if (this.isRunning) {
                this.animationFrame = requestAnimationFrame(() => this.update());
            }
        }

        start() {
            if (this.isRunning) return; 
            this.isRunning = true;
            this.startTime = Date.now();
            this.startStopBtn.textContent = "STOP";
            this.startStopBtn.className = "btn-toggle btn-stop";
            this.lapBtn.disabled = false;
            this.update();
        }

        stop() {
            if (!this.isRunning) return;
            this.isRunning = false;
            this.elapsedSaved += Date.now() - this.startTime;
            cancelAnimationFrame(this.animationFrame);
            this.startStopBtn.textContent = "START";
            this.startStopBtn.className = "btn-toggle btn-start";
            this.lapBtn.disabled = true;
        }

        lap() {
            if (!this.isRunning) return;
            const now = Date.now();
            const totalTime = this.elapsedSaved + (now - this.startTime);
            const splitTime = totalTime - this.currentLapStart;

            const lapData = {
                count: this.laps.length + 1,
                split: splitTime,
                total: totalTime
            };
            this.laps.unshift(lapData);

            this.lastLapDisplay.textContent = formatTime(splitTime);
            this.currentLapStart = totalTime;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="mono" style="color:#9ca3af;">${lapData.count}</td>
                <td class="mono lap-split">${formatTime(lapData.split)}</td>
                <td class="mono" style="color:#6b7280;">${formatTime(lapData.total)}</td>
            `;
            this.tbody.prepend(row);
        }

        reset() {
            this.stop();
            this.elapsedSaved = 0;
            this.startTime = 0;
            this.laps = [];
            this.currentLapStart = 0;
            this.totalTimeDisplay.textContent = "00:00.00";
            this.currentLapDisplay.textContent = "00:00.00";
            this.lastLapDisplay.textContent = "00:00.00";
            this.tbody.innerHTML = "";
        }

        getName() { return this.nameInput.value || `選手 ${this.id}`; }
    }

    // --- グローバル関数 ---

    function getAthlete(id) { return athletes.find(a => a.id === id); }

    function addAthlete() {
        const stopwatch = new Stopwatch(nextId);
        athletes.push(stopwatch);
        const container = document.getElementById('athletes-container');
        const btnArea = document.getElementById('add-btn-area');
        container.insertBefore(stopwatch.element, btnArea);
        nextId++;
    }

    function removeAthlete(id) {
        if (!confirm("削除しますか？")) return;
        const index = athletes.findIndex(a => a.id === id);
        if (index > -1) {
            athletes[index].element.remove();
            athletes.splice(index, 1);
        }
    }

    function toggleTimer(id) {
        const s = getAthlete(id);
        if (s.isRunning) s.stop(); else s.start();
    }
    function recordLap(id) { getAthlete(id).lap(); }
    function resetTimer(id) { if(confirm("リセットしますか？")) getAthlete(id).reset(); }

    function startAll() { athletes.forEach(a => a.start()); }
    function stopAll() { athletes.forEach(a => a.stop()); }
    function lapAll() { athletes.forEach(a => a.lap()); }

    // --- 編集・スプレッドシート機能 ---

    function finishMeasurement() {
        if(confirm("測定を終了して、結果編集画面へ移動しますか？\n（動いているタイマーは全て停止します）")) {
            stopAll();
            
            // 現在の日付をタイトルに
            const today = new Date();
            const dateStr = `${today.getMonth()+1}月${today.getDate()}日`;
            document.getElementById('result-title').textContent = `${dateStr} ラン計測結果`;

            document.getElementById('measurement-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.remove('hidden');
            generateSpreadsheet();
        }
    }

    function backToMeasurement() {
        document.getElementById('edit-screen').classList.add('hidden');
        document.getElementById('measurement-screen').classList.remove('hidden');
    }

    function generateSpreadsheet() {
        const table = document.getElementById('result-table');
        table.innerHTML = ""; // クリア

        // 1. ヘッダー行の作成
        const thead = document.createElement('thead');
        
        // 1行目: 選手名 (空セル + 名前 + 空セル...)
        const rowNames = document.createElement('tr');
        rowNames.appendChild(document.createElement('th')); // 左上の空き
        
        // 2行目: 項目名 (LapNo + Split + Total...)
        const rowLabels = document.createElement('tr');
        const thLap = document.createElement('th');
        thLap.textContent = "Lap";
        rowLabels.appendChild(thLap);

        athletes.forEach(a => {
            // 選手名セル (2列分結合)
            const thName = document.createElement('th');
            thName.colSpan = 2;
            thName.className = 'th-name';
            thName.innerHTML = `<input value="${a.getName()}" style="font-weight:bold; background:transparent;">`;
            rowNames.appendChild(thName);

            // 項目セル
            const thSplit = document.createElement('th'); thSplit.textContent = "Split";
            const thTotal = document.createElement('th'); thTotal.textContent = "Total";
            rowLabels.appendChild(thSplit);
            rowLabels.appendChild(thTotal);
        });

        thead.appendChild(rowNames);
        thead.appendChild(rowLabels);
        table.appendChild(thead);

        // 2. ボディ行（データ）の作成
        const tbody = document.createElement('tbody');
        
        // 最大ラップ数を探す
        let maxLaps = 0;
        athletes.forEach(a => { if(a.laps.length > maxLaps) maxLaps = a.laps.length; });

        // ラップの数だけループ（1周目から順に）
        for (let i = 1; i <= maxLaps; i++) {
            const row = document.createElement('tr');
            
            // 左端のラップ番号
            const tdNo = document.createElement('td');
            tdNo.style.backgroundColor = "#f9fafb";
            tdNo.innerHTML = `<input value="${i}Lap" readonly style="background:#f9fafb; color:#888;">`;
            row.appendChild(tdNo);

            // 各選手のデータ
            athletes.forEach(a => {
                // laps配列はunshiftで逆順に入っているので、正順(i番目)を取得するには工夫が必要
                // array index は 0始まり。ラップ1は配列の末尾(length-1)
                // 単純化のため、lapsをコピーしてreverseした一時配列を使う
                const orderedLaps = [...a.laps].reverse();
                const lapData = orderedLaps[i-1]; // i番目のラップ

                const tdSplit = document.createElement('td');
                const tdTotal = document.createElement('td');

                if (lapData) {
                    tdSplit.innerHTML = `<input value="${formatTime(lapData.split)}">`;
                    tdTotal.innerHTML = `<input value="${formatTime(lapData.total)}">`;
                } else {
                    tdSplit.innerHTML = `<input value="">`; // データなし
                    tdTotal.innerHTML = `<input value="">`;
                }
                row.appendChild(tdSplit);
                row.appendChild(tdTotal);
            });

            tbody.appendChild(row);
        }
        table.appendChild(tbody);
    }

    // Excel互換のTSV形式でコピー
    async function copySpreadsheet() {
        const table = document.getElementById('result-table');
        let tsv = "";

        // 行ごとに処理
        for (const row of table.rows) {
            let rowData = [];
            for (const cell of row.cells) {
                // inputがある場合はその値を、なければinnerTextを使う
                const input = cell.querySelector('input');
                let val = input ? input.value : cell.innerText;
                
                // Excel貼り付け用に余計な改行などを除去
                val = val.replace(/(\r\n|\n|\r)/gm, "").trim();
                rowData.push(val);
            }
            // タブ区切りで結合
            tsv += rowData.join("\t") + "\n";
        }

        try {
            await navigator.clipboard.writeText(tsv);
            alert("コピーしました！\nExcelやスプレッドシートのA1セルを選択して貼り付けてください。");
        } catch (err) {
            alert("コピーに失敗しました...");
        }
    }

    window.onload = () => {
        addAthlete(); addAthlete(); addAthlete();
    };
</script>

</body>
</html>
