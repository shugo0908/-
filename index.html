<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triathlon Manager - Run v5</title>
    <style>
        /* --- デザイン設定 --- */
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --border-color: #e5e7eb;
            --red: #ef4444;
            --green: #22c55e;
            --blue: #3b82f6;
            --gray: #9ca3af;
            --purple: #8b5cf6;
            --orange: #f97316;
            --gap-red: #dc2626;   /* 遅れ用 */
            --gap-blue: #2563eb;  /* 先行用 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; background-color: #111827;
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        header {
            height: 40px; background-color: #1f2937; color: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; font-size: 14px; font-weight: bold; flex-shrink: 0;
        }

        .screen {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            width: 100%; height: 100%;
        }
        .hidden { display: none !important; }

        /* --- 測定画面 --- */
        #athletes-container {
            flex: 1; display: flex; overflow-x: auto; overflow-y: hidden;
            background-color: var(--bg-color); padding-bottom: 80px; 
        }

        .stopwatch-card {
            flex: 0 0 320px; background-color: var(--card-bg);
            border-right: 1px solid var(--border-color); display: flex;
            flex-direction: column; padding: 12px; position: relative;
            box-sizing: border-box; height: 100%;
        }

        .delete-btn {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: var(--border-color); cursor: pointer; font-size: 18px;
        }
        .delete-btn:hover { color: var(--red); }

        /* 名前入力 */
        .name-input {
            font-size: 18px; font-weight: bold; text-align: center; border: none;
            border-bottom: 2px solid var(--border-color); width: 90%;
            margin: 0 auto 4px auto; padding: 4px; outline: none;
        }
        .name-input:focus { border-color: var(--blue); }

        /* ターゲット入力エリア */
        .target-wrapper {
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px; gap: 5px;
        }
        .target-label { font-size: 11px; color: #666; font-weight: bold; }
        .target-input {
            width: 80px; text-align: center; font-family: monospace; font-size: 14px;
            padding: 2px; border: 1px solid #ddd; border-radius: 4px; background: #f9fafb;
        }
        .target-input:focus { border-color: var(--blue); background: white; outline: none; }

        /* 時間表示エリア */
        .time-display-area {
            background-color: #f9fafb; border-radius: 8px; padding: 10px;
            text-align: center; margin-bottom: 12px;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }

        .main-time-label { font-size: 10px; color: var(--gray); font-weight: bold; }
        .main-time {
            font-family: monospace; font-size: 32px; font-weight: bold;
            color: var(--text-main); letter-spacing: 1px; margin: 2px 0 8px 0;
        }

        .sub-times { display: flex; gap: 8px; }
        .sub-time-box {
            flex: 1; background: white; border: 1px solid var(--border-color);
            border-radius: 4px; padding: 4px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .sub-label { font-size: 9px; font-weight: bold; text-transform: uppercase; color: #666; }
        .sub-time { font-family: monospace; font-size: 16px; font-weight: bold; }

        /* GAP表示用 */
        .gap-display {
            font-size: 12px; font-weight: bold; margin-top: 2px;
        }
        .gap-plus { color: var(--gap-red); }
        .gap-minus { color: var(--gap-blue); }

        .controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .row-btns { display: flex; gap: 8px; height: 40px; }
        
        button {
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
            font-size: 14px; transition: opacity 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #d1d5db; cursor: not-allowed; }

        .btn-start { background-color: var(--green); color: white; flex: 1; }
        .btn-stop { background-color: var(--red); color: white; flex: 1; }
        .btn-lap { background-color: var(--blue); color: white; flex: 1; }
        .btn-reset { background-color: #e5e7eb; color: #4b5563; width: 100%; padding: 8px; }

        .lap-list-container {
            flex: 1; overflow-y: auto; background-color: #f9fafb;
            border: 1px solid var(--border-color); border-radius: 4px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 13px; text-align: center; }
        th { background-color: #f3f4f6; padding: 6px; font-size: 11px; color: var(--gray); position: sticky; top: 0; }
        td { padding: 4px; border-bottom: 1px solid #e5e7eb; color: var(--text-main); }
        .mono { font-family: monospace; }
        .lap-split { font-weight: bold; color: #1f2937; }
        
        /* リスト内のGAP */
        .list-gap { font-size: 10px; margin-left: 4px; }

        #add-btn-area {
            flex: 0 0 100px; display: flex; align-items: center; justify-content: center;
            background-color: #e5e7eb; border-left: 1px solid #d1d5db;
        }
        .add-circle {
            width: 60px; height: 60px; border-radius: 50%; background-color: white;
            color: var(--blue); display: flex; align-items: center; justify-content: center;
            font-size: 32px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); cursor: pointer;
        }

        /* --- 一括操作バー --- */
        #global-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background-color: #1f2937; display: flex; align-items: center;
            justify-content: space-around; padding: 0 10px; box-sizing: border-box;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.2); z-index: 100;
        }
        
        .global-btn {
            height: 50px; flex: 1; margin: 0 5px; font-size: 16px; color: white;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .global-btn span { font-size: 10px; font-weight: normal; margin-top: 2px; opacity: 0.8; }

        .g-start { background-color: #16a34a; }
        .g-lap { background-color: #2563eb; }
        .g-stop { background-color: #dc2626; }
        .g-finish { background-color: var(--orange); }

        /* --- 編集画面 --- */
        #edit-screen {
            background-color: var(--bg-color); padding: 10px; box-sizing: border-box;
        }

        .edit-container {
            width: 100%; height: 100%; background: white; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;
            overflow: hidden;
        }

        .sheet-header {
            padding: 10px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sheet-header h2 { margin: 0; font-size: 16px; }

        .spreadsheet-wrapper { flex: 1; overflow: auto; padding: 10px; }
        .spreadsheet-table { border-collapse: collapse; width: max-content; }
        .spreadsheet-table th, .spreadsheet-table td { border: 1px solid #ccc; padding: 0; min-width: 60px; }
        .spreadsheet-table th {
            background-color: #f3f4f6; padding: 8px; font-size: 12px;
            text-align: center; position: sticky; top: 0; z-index: 10;
        }
        .spreadsheet-table input {
            width: 100%; height: 100%; border: none; padding: 8px;
            box-sizing: border-box; font-family: monospace; font-size: 13px; text-align: center;
        }
        .spreadsheet-table input:focus { background-color: #eff6ff; outline: 2px solid var(--blue); z-index: 5; }
        .th-name { background-color: #e5e7eb; font-weight: bold; }

        .edit-actions { display: flex; gap: 10px; padding: 10px; border-top: 1px solid #ddd; }
        .btn-copy { background-color: #107c41; color: white; flex: 2; font-size: 16px; }
        .btn-back { background-color: #6b7280; color: white; flex: 1; font-size: 16px; }

    </style>
</head>
<body>

<header>
    <span>Run Manager v5 (Target & Gap)</span>
</header>

<div id="measurement-screen" class="screen">
    <div id="athletes-container">
        <div id="add-btn-area">
            <div class="add-circle" onclick="addAthlete()">+</div>
        </div>
    </div>

    <div id="global-controls">
        <button class="global-btn g-start" onclick="startAll()">START<span>一括開始</span></button>
        <button class="global-btn g-lap" onclick="lapAll()">LAP<span>一括ラップ</span></button>
        <button class="global-btn g-stop" onclick="stopAll()">STOP<span>一括停止</span></button>
        <button class="global-btn g-finish" onclick="finishMeasurement()">FINISH<span>測定終了</span></button>
    </div>
</div>

<div id="edit-screen" class="screen hidden">
    <div class="edit-container">
        <div class="sheet-header">
            <h2 id="result-title">計測結果</h2>
        </div>
        
        <div class="spreadsheet-wrapper">
            <table class="spreadsheet-table" id="result-table">
                </table>
        </div>

        <div class="edit-actions">
            <button class="btn-back" onclick="backToMeasurement()">戻る</button>
            <button class="btn-copy" onclick="copySpreadsheet()">Excel形式でコピー</button>
        </div>
    </div>
</div>

<script>
    let athletes = [];
    let nextId = 1;

    // mm:ss.ms 形式
    function formatTime(ms) {
        if (ms === 0) return "00:00.00";
        const minutes = Math.floor(Math.abs(ms) / 60000);
        const seconds = Math.floor((Math.abs(ms) % 60000) / 1000);
        const milliseconds = Math.floor((Math.abs(ms) % 1000) / 10);
        
        const sign = ms < 0 ? "-" : "";
        return `${sign}${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
    }

    // GAP表示用 (+01.50 など)
    function formatGap(ms) {
        const sign = ms > 0 ? "+" : "-"; // 遅れがプラス、先行がマイナス
        const absMs = Math.abs(ms);
        const seconds = Math.floor(absMs / 1000);
        const milliseconds = Math.floor((absMs % 1000) / 10);
        return `${sign}${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
    }

    // 入力された文字列（"80" や "1:20"）をミリ秒に変換
    function parseTargetInput(str) {
        if (!str) return null;
        // 全角数字を半角に
        str = str.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        
        if (str.includes(":")) {
            // mm:ss 形式
            const parts = str.split(":");
            if (parts.length === 2) {
                const m = parseInt(parts[0]) || 0;
                const s = parseInt(parts[1]) || 0;
                return (m * 60 + s) * 1000;
            }
        } else {
            // 秒数のみ (例: 78)
            const s = parseInt(str);
            if (!isNaN(s)) {
                return s * 1000;
            }
        }
        return null;
    }

    class Stopwatch {
        constructor(id) {
            this.id = id;
            this.startTime = 0; this.elapsedSaved = 0; this.isRunning = false;
            this.animationFrame = null; this.laps = []; this.currentLapStart = 0; 

            this.element = document.createElement('div');
            this.element.className = 'stopwatch-card';
            this.element.id = `athlete-${id}`;
            this.render();
            
            // DOM要素取得
            this.nameInput = this.element.querySelector('.name-input');
            this.targetInput = this.element.querySelector('.target-input'); // ターゲット入力
            this.totalTimeDisplay = this.element.querySelector('.main-time');
            this.currentLapDisplay = this.element.querySelector('.current-lap');
            this.lastLapDisplay = this.element.querySelector('.last-lap');
            this.gapDisplay = this.element.querySelector('.gap-display'); // GAP表示
            this.startStopBtn = this.element.querySelector('.btn-toggle');
            this.lapBtn = this.element.querySelector('.btn-lap');
            this.tbody = this.element.querySelector('tbody');
        }

        render() {
            this.element.innerHTML = `
                <button class="delete-btn" onclick="removeAthlete(${this.id})">×</button>
                <input type="text" class="name-input" placeholder="氏名" value="選手 ${this.id}">
                
                <div class="target-wrapper">
                    <span class="target-label">Target:</span>
                    <input type="text" class="target-input" placeholder="例: 78, 1:18">
                </div>

                <div class="time-display-area">
                    <div class="main-time-label">TOTAL TIME</div>
                    <div class="main-time">00:00.00</div>
                    <div class="sub-times">
                        <div class="sub-time-box">
                            <span class="sub-label">Current Lap</span>
                            <span class="sub-time current-lap text-blue">00:00.00</span>
                        </div>
                        <div class="sub-time-box">
                            <span class="sub-label">Last Lap & Gap</span>
                            <span class="sub-time last-lap text-green">00:00.00</span>
                            <span class="gap-display">--</span>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <div class="row-btns">
                        <button class="btn-toggle btn-start" onclick="toggleTimer(${this.id})">START</button>
                        <button class="btn-lap" onclick="recordLap(${this.id})" disabled>LAP</button>
                    </div>
                    <button class="btn-reset" onclick="resetTimer(${this.id})">RESET</button>
                </div>

                <div class="lap-list-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>SPLIT (Gap)</th>
                                <th>TOTAL</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;
        }

        update() {
            const now = Date.now();
            const totalTime = this.elapsedSaved + (this.isRunning ? (now - this.startTime) : 0);
            this.totalTimeDisplay.textContent = formatTime(totalTime);
            const currentLapTime = totalTime - this.currentLapStart;
            this.currentLapDisplay.textContent = formatTime(currentLapTime);
            if (this.isRunning) {
                this.animationFrame = requestAnimationFrame(() => this.update());
            }
        }

        start() {
            if (this.isRunning) return; 
            this.isRunning = true;
            this.startTime = Date.now();
            this.startStopBtn.textContent = "STOP";
            this.startStopBtn.className = "btn-toggle btn-stop";
            this.lapBtn.disabled = false;
            this.update();
        }

        stop() {
            if (!this.isRunning) return;
            this.isRunning = false;
            this.elapsedSaved += Date.now() - this.startTime;
            cancelAnimationFrame(this.animationFrame);
            this.startStopBtn.textContent = "START";
            this.startStopBtn.className = "btn-toggle btn-start";
            this.lapBtn.disabled = true;
        }

        lap() {
            if (!this.isRunning) return;
            const now = Date.now();
            const totalTime = this.elapsedSaved + (now - this.startTime);
            const splitTime = totalTime - this.currentLapStart;

            // ターゲットタイムとの差を計算
            let gapMs = null;
            const targetMs = parseTargetInput(this.targetInput.value);
            if (targetMs) {
                gapMs = splitTime - targetMs; // プラスなら遅い、マイナスなら速い
            }

            const lapData = {
                count: this.laps.length + 1,
                split: splitTime,
                total: totalTime,
                gap: gapMs
            };
            this.laps.unshift(lapData);

            // 表示更新
            this.lastLapDisplay.textContent = formatTime(splitTime);
            
            // GAP表示更新
            if (gapMs !== null) {
                const gapStr = formatGap(gapMs);
                this.gapDisplay.textContent = gapStr;
                this.gapDisplay.className = gapMs > 0 ? "gap-display gap-plus" : "gap-display gap-minus";
            } else {
                this.gapDisplay.textContent = "--";
                this.gapDisplay.className = "gap-display";
            }

            this.currentLapStart = totalTime;

            // リストに追加
            const row = document.createElement('tr');
            let gapHtml = "";
            if (gapMs !== null) {
                const colorClass = gapMs > 0 ? "gap-plus" : "gap-minus";
                gapHtml = `<span class="list-gap ${colorClass}">(${formatGap(gapMs)})</span>`;
            }

            row.innerHTML = `
                <td class="mono" style="color:#9ca3af;">${lapData.count}</td>
                <td class="mono lap-split">${formatTime(lapData.split)} ${gapHtml}</td>
                <td class="mono" style="color:#6b7280;">${formatTime(lapData.total)}</td>
            `;
            this.tbody.prepend(row);
        }

        reset() {
            this.stop();
            this.elapsedSaved = 0;
            this.startTime = 0;
            this.laps = [];
            this.currentLapStart = 0;
            this.totalTimeDisplay.textContent = "00:00.00";
            this.currentLapDisplay.textContent = "00:00.00";
            this.lastLapDisplay.textContent = "00:00.00";
            this.gapDisplay.textContent = "--";
            this.tbody.innerHTML = "";
        }

        getName() { return this.nameInput.value || `選手 ${this.id}`; }
    }

    // --- グローバル関数 ---

    function getAthlete(id) { return athletes.find(a => a.id === id); }

    function addAthlete() {
        const stopwatch = new Stopwatch(nextId);
        athletes.push(stopwatch);
        const container = document.getElementById('athletes-container');
        const btnArea = document.getElementById('add-btn-area');
        container.insertBefore(stopwatch.element, btnArea);
        nextId++;
    }

    function removeAthlete(id) {
        if (!confirm("削除しますか？")) return;
        const index = athletes.findIndex(a => a.id === id);
        if (index > -1) {
            athletes[index].element.remove();
            athletes.splice(index, 1);
        }
    }

    function toggleTimer(id) {
        const s = getAthlete(id);
        if (s.isRunning) s.stop(); else s.start();
    }
    function recordLap(id) { getAthlete(id).lap(); }
    function resetTimer(id) { if(confirm("リセットしますか？")) getAthlete(id).reset(); }

    function startAll() { athletes.forEach(a => a.start()); }
    function stopAll() { athletes.forEach(a => a.stop()); }
    function lapAll() { athletes.forEach(a => a.lap()); }

    // --- 編集・書き出し機能 ---

    function finishMeasurement() {
        if(confirm("測定を終了して、結果編集画面へ移動しますか？")) {
            stopAll();
            const today = new Date();
            const dateStr = `${today.getMonth()+1}月${today.getDate()}日`;
            document.getElementById('result-title').textContent = `${dateStr} ラン計測結果`;
            document.getElementById('measurement-screen').classList.add('hidden');
            document.getElementById('edit-screen').classList.remove('hidden');
            generateSpreadsheet();
        }
    }

    function backToMeasurement() {
        document.getElementById('edit-screen').classList.add('hidden');
        document.getElementById('measurement-screen').classList.remove('hidden');
    }

    function generateSpreadsheet() {
        const table = document.getElementById('result-table');
        table.innerHTML = ""; 

        // ヘッダー生成
        const thead = document.createElement('thead');
        const rowNames = document.createElement('tr');
        rowNames.appendChild(document.createElement('th')); 
        const rowLabels = document.createElement('tr');
        rowLabels.appendChild(document.createElement('th')); 
        rowLabels.lastChild.textContent = "Lap";

        athletes.forEach(a => {
            // 名前 (3列結合: Split, Gap, Total)
            const thName = document.createElement('th');
            thName.colSpan = 3;
            thName.className = 'th-name';
            thName.innerHTML = `<input value="${a.getName()}" style="font-weight:bold; background:transparent;">`;
            rowNames.appendChild(thName);

            const thSplit = document.createElement('th'); thSplit.textContent = "Time";
            const thGap = document.createElement('th'); thGap.textContent = "Gap";
            const thTotal = document.createElement('th'); thTotal.textContent = "Total";
            rowLabels.appendChild(thSplit);
            rowLabels.appendChild(thGap);
            rowLabels.appendChild(thTotal);
        });
        thead.appendChild(rowNames);
        thead.appendChild(rowLabels);
        table.appendChild(thead);

        // データ生成
        const tbody = document.createElement('tbody');
        let maxLaps = 0;
        athletes.forEach(a => { if(a.laps.length > maxLaps) maxLaps = a.laps.length; });

        for (let i = 1; i <= maxLaps; i++) {
            const row = document.createElement('tr');
            
            const tdNo = document.createElement('td');
            tdNo.innerHTML = `<input value="${i}" readonly style="background:#f9fafb; color:#888;">`;
            row.appendChild(tdNo);

            athletes.forEach(a => {
                const orderedLaps = [...a.laps].reverse();
                const lapData = orderedLaps[i-1]; 

                const tdSplit = document.createElement('td');
                const tdGap = document.createElement('td');
                const tdTotal = document.createElement('td');

                if (lapData) {
                    tdSplit.innerHTML = `<input value="${formatTime(lapData.split)}">`;
                    // Gapがあれば表示
                    const gapVal = lapData.gap !== null ? formatGap(lapData.gap) : "";
                    tdGap.innerHTML = `<input value="${gapVal}" style="color:${lapData.gap > 0 ? 'red':'blue'}">`;
                    tdTotal.innerHTML = `<input value="${formatTime(lapData.total)}">`;
                } else {
                    tdSplit.innerHTML = `<input value="">`;
                    tdGap.innerHTML = `<input value="">`;
                    tdTotal.innerHTML = `<input value="">`;
                }
                row.appendChild(tdSplit);
                row.appendChild(tdGap);
                row.appendChild(tdTotal);
            });
            tbody.appendChild(row);
        }
        table.appendChild(tbody);
    }

    async function copySpreadsheet() {
        const table = document.getElementById('result-table');
        let tsv = "";
        for (const row of table.rows) {
            let rowData = [];
            for (const cell of row.cells) {
                const input = cell.querySelector('input');
                let val = input ? input.value : cell.innerText;
                val = val.replace(/(\r\n|\n|\r)/gm, "").trim();
                rowData.push(val);
            }
            tsv += rowData.join("\t") + "\n";
        }
        try {
            await navigator.clipboard.writeText(tsv);
            alert("コピーしました！");
        } catch (err) {
            alert("コピー失敗");
        }
    }

    window.onload = () => {
        addAthlete(); addAthlete(); addAthlete();
    };
</script>

</body>
</html>
